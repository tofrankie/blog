---
title: React Query å°è®°
number: '#376'
link: 'https://github.com/tofrankie/blog/issues/376'
created_at: '2025-11-17 17:20:11'
updated_at: '2025-11-17 17:50:40'
labels:
  - React
  - å‰ç«¯
  - '2025'
---
![é…å›¾æºè‡ª Freepik](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1763373011752.jpg)

> æœ¬æ–‡ä»¥ V5 ç‰ˆæœ¬ä¸ºä¾‹

## Query Key

å®ƒæ˜¯ç”±å­—ç¬¦ä¸²ã€ï¼ˆå¯åµŒå¥—ï¼‰å¯¹è±¡ã€æˆ–ä¸¤è€…å…¼å…·ç»„æˆçš„æ•°ç»„ã€‚

### é¡ºåº

æ•°ç»„çš„é¡ºåºå¾ˆé‡è¦

```ts
// ä»¥ä¸‹ Query Key ä¸ç›¸åŒ
useQuery({ queryKey: ['todos', status, page] })
useQuery({ queryKey: ['todos', page, status] })
useQuery({ queryKey: ['todos', undefined, page, status] })
```

å¯¹è±¡çš„é¡ºåºä¸é‡è¦

```ts
// ä»¥ä¸‹ Query Key ç›¸åŒ
useQuery({ queryKey: ['todos', { status, page }] })
useQuery({ queryKey: ['todos', { page, status }] })
useQuery({ queryKey: ['todos', { page, status, other: undefined }] })
```

å¯¹è±¡æ€»æ˜¯ä»¥ç¡®å®šæ€§çš„ sort æ’åºï¼šğŸ‘‡

```ts
/**
 * Default query & mutation keys hash function.
 * Hashes the value into a stable hash.
 */
export function hashKey(queryKey: QueryKey | MutationKey): string {
  return JSON.stringify(queryKey, (_, val) =>
    isPlainObject(val)
      ? Object.keys(val)
          .sort()
          .reduce((result, key) => {
            result[key] = val[key]
            return result
          }, {} as any)
      : val,
  )
}
```

### ç»“æ„åŒ–

å°½ç®¡ Query Key åœ¨æ•´ä¸ª Query ä¸­å”¯ä¸€ä¾¿å¯ä½¿ç”¨ï¼Œä½†æˆ‘ä»¬å¯ä»¥æŒ‰ä¸€å®šçš„é¢—ç²’åº¦è¿›è¡Œåˆ’åˆ†ã€‚æ¯”å¦‚ï¼š

```ts
useQuery({ queryKey: ['todos', 'list', { filters: 'all' }] })
useQuery({ queryKey: ['todos', 'list', { filters: 'done' }] })
useQuery({ queryKey: ['todos', 'detail', 1] })
useQuery({ queryKey: ['todos', 'detail', 2] })
```
è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œåœ¨å¤„ç†æ•°æ®æ›´æ–°æ—¶æ›´åŠ çµæ´»ï¼Œæˆ–è€…æ‰¹é‡ä½¿å¯¹åº”ç¼“å­˜å¤±æ•ˆï¼š

```ts
function useUpdateTitle() {
  return useMutation({
    mutationFn: updateTitle,
    onSuccess: newTodo => {
      // æ›´æ–°å•ä¸ªæ•°æ®
      queryClient.setQueryData(['todos', 'detail', newTodo.id], newTodo)

      // æ›´æ–°åˆ—è¡¨æ•°æ®
      queryClient.setQueriesData(['todos', 'list'], previous =>
        previous.map(todo => (todo.id === newTodo.id ? newTodo : todo))
      )

      // ä½¿æŸ¥è¯¢åˆ—è¡¨å¤±æ•ˆ
      queryClient.invalidateQueries({queryKey: ['todos', 'list']})
    },
  })
}
```

Related link: https://tkdodo.eu/blog/effective-react-query-keys#structure

æœ‰æ—¶ï¼Œä½¿ç”¨â€œçº¯å¯¹è±¡â€çš„ Query Key æ›´å¥½ï¼š

```ts
function useTodosQuery(filter: string) {
  return useQuery({
    // queryKey: ["todos", "list", filter],
    queryKey: [{scope: 'todos', entity: 'list', filter}],
    queryFn: ({queryKey}) => {
      // ä¿ä¸å‡†ä¸‹æ¬¡ä¼šæ–°å¢ä»€ä¹ˆå‚æ•°ï¼Œæ­¤æ—¶å¯¹è±¡è¦ä¼˜äºæ•°ç»„
      // const [, , filter] = queryKey;
      const {filter} = queryKey
      return fetchTodos({filter})
    },
  })
}
```

Related Link: https://tkdodo.eu/blog/leveraging-the-query-function-context#object-query-keys

## Select

åœ¨ useQuery æˆ– useInfinityQuery ä¸­çš„ select ä¼šåœ¨æ¯æ¬¡ç»„ä»¶æ›´æ–°æ—¶æ‰§è¡Œï¼Œè€Œä¸æ˜¯æŸ¥è¯¢ç»“æœå˜åŒ–æ—¶æ‰æ‰§è¡Œï¼Œæ‰€ä»¥æŒ‰éœ€ä½¿ç”¨ useCallbackï¼ˆä½†å¦‚æœå¤„ç†ä¸ä¼šå¾ˆå¤æ‚ï¼Œä¹Ÿä¸éœ€è¦ç¼“å­˜å¤„ç†ï¼‰ã€‚

## References

- [TkDodo's blog](https://tkdodo.eu/blog/practical-react-query)

