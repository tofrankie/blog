---
title: GIF 图片优化
number: '#377'
link: 'https://github.com/tofrankie/blog/issues/377'
created_at: '2025-11-24 18:32:41'
updated_at: '2025-12-28 22:30:27'
labels:
  - 前端
  - '2022'
---

![配图源自 Freepik](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1764119901038.jpg)

## 背景

在微信交互图文中，除了 JPG、PNG 图片之外，更多的是 GIF 动图，且所占比例比较高。本文就 GIF 图片优化作相关调研。

## GIF 文件

[GIF](https://www.wikiwand.com/en/gif)（Graphics Interchange Format）是 1987 年创建的一种位图图形交互文件格式，目前有 87a 和 89a 两种版本。其颜色深度只有 8bit，可最多支持 256 种颜色。

发音：

- [dʒɪf] - 发音同 jif，创建者认证的发音。
- [ɡɪf] - 发音同 gift，被更广泛使用的发音。

深入了解：

- [GIF89a Specification](https://www.w3.org/Graphics/GIF/spec-gif89a.txt)
- [GIF Application Extensions](http://www.vurdalakov.net/misc/gif)
- [What's In A GIF](http://www.matthewflickinger.com/lab/whatsinagif/)
- [GIF Signature Format: Introduction & Recovery](https://www.ntfs.com/gif-signature-format.htm)
- [Wikiwand GIF](https://www.wikiwand.com/en/gif)

文件格式：

![](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1763980186371.png)

<!--
文件格式：

GIF 文件结构
GIF 文件结构
Header

文件头

Signature 署名	
一个固定值 GIF，表示文件标识。
Version 版本号	
版本号：87a、89a。
Data Stream

数据流







Logical Screen Descriptor 逻辑屏幕标识符	Logical Screen Width 宽度	即 GIF 图片分辨率。
Logical Screen Height 高度	
Global Color Table Flag 全局颜色列表

Size of Global Color Table 尺寸

全局颜色表标识，取值 0 或 1，其中 1 时表示有定义 GCT。

GCT 尺寸（取值范围 1 ~ 8）。

此处省略了一部分不太重要字段。

Background Color Index 背景色索引	当 GCT Flag 为 1 时有效。即有 GCT 该索引值才有用。
Pixel Aspect Radio 像素宽高比	用于计算原始图像的宽高比，对于本文不太重要...
Global Color Table 全局颜色表（GCT，可选）	
供没有本地颜色表的图像和纯文本扩展使用，计算方式：GCT 字节数 = 3 * 2^(Size of GCT)。

三原色 RGB 都是 8bit 组合而成的，因此一种颜色占 3 字节。

颜色表中的颜色数量为 2 的 N 次方，其中 N 是 Size of Global Color Table。

故而颜色表数量可以是 2、4、8 ... 128、256。

Image Block 图像块（即每帧图像）	
Graphic Control Extension 图像控制扩展（89a，可选）

Delay Time 延迟时间
Transparent Color Index 透明色索引值
Disposal Method 处置方式
Transparent Color  Flag 透明色标识
...
简单来说，它用于控制紧跟它后面的图像或文本（即当前帧）的渲染形式。

包括了切换下一帧的延迟时间、是否使用透明色、与上一帧的叠加方式等等。

Comment Extension 注释扩展（89a，可选）	它不属于渲染数据流中的一部分，因此不会对图像渲染造成任何影响。比如标记作者、版权等信息。
Plain Text Extension 纯文本扩展（89a，可选）	
用于绘制一个纯文本图像。其字体和字号无法自定义，解码器会根据系统自动选择，

因此很多 GIF 并不会包含这一部分扩展内容。

Application Extension 应用程序扩展（89a，可选）

Loop Count 迭代次数（非官方规范）
定义应用本身的标识信息。比如，一些 GIF 图片编辑工具可往里面写入了一些信息。

请注意，这里的迭代次数是 Netscape 定义的，其中 LP 为 0 表示无限循环。

当 LP 为 1 时，表示每一帧都会播放两次。

Image Descriptor 图像标识符

Image Left Position 左偏移量
Image Top Position 上偏移量
Image Width 宽度
Image Height 高度
Local Color Table Flag 本地颜色表标识
Size of Local Color Table 尺寸
...
包含了 X、Y 方向偏移量、图像宽高、LCT 标识、交织标识、LCT 尺寸 等内容。

Local Color Table 本地颜色表（LCT，可选）	当不存在 LCT 时，颜色索引值会前往 GCT 查找，其他与 GCT 同理。
Table-Based Image Data 基于颜色列表的图像数据	包含了 LZW 编码长度和图像数据，其中图像数据使用了 LZW 无损压缩算法。
Trailer

文件结尾

GIF Trailer

一个固定值 0x3B，表示 GIF 文件的结束。
-->

## 相关工具

一些工具：

- [FFmpeg](https://ffmpeg.org/ffmpeg.html)
- [Gifsicle](https://www.lcdf.org/gifsicle/man.html)
- [ImageMagick](https://imagemagick.org/script/command-line-processing.php)
- [GraphicsMagick](http://www.graphicsmagick.org/index.html)

```shell
$ brew install ffmpeg gifsicle imagemagick graphicsmagick
```

网上大多数 GIF 压缩应用都是基于开源的 Gifsicle 封装的，本文也将使用到它。

一些命令：

```shell
# 查看所有帧信息
$ gifsicle --info source.gif

# 查看某帧信息
$ gifsicle --info "#0" "#3" < source.gif

# 查看详细颜色表
$ gifsicle --cinfo source.gif

# 逐帧导出（ImageMagick）
$ convert source.gif target.png
```

## 优化方向

> [!TIP]
> 本文提供了一些 GIF 优化方向，但是否适合你的，应按实际情况仔细斟酌。

### 1. 降低分辨率

提到图片优化，降低分辨率自然是首先想到的方向之一。

```shell
$ gifsicle --resize-width=width source.gif > target.gif
```

对于其他项目，这或许是一个不错的选择。但在微信交互图文，设计师交付的 GIF 图片基本上是 @1.5x 倍图，常见为 514 × 940 像素。如果进一步降低分辨率的话，在 DPR 为 3 及更高的高清屏下显示效果不好。

### 2. 移除无用的扩展内容

在 GIF 文件中，有一部分扩展内容（比如注释扩展）是对数据流渲染没有影响，因此是可以移除的。

```shell
# 移除应用程序扩展（亲测发现不会影响 Loop Count）
$ gifsicle --no-app-extensions source.gif > target.gif

# 移除注释扩展
$ gifsicle --no-comments source.gif > target.gif

# 移除扩展（文档中未注明哪一种扩展）
$ gifsicle --no-extensions source.gif > target.gif

# 移除帧文本名称（可理解为帧的别名）
$ gifsicle --no-names source.gif > target.gif
```

平常对帧的操作，命令通常是 `gifsicle "#0" ...`，使用别名（如果有的话）是 `gifsicle "#first" ...`。其作用仅此而已，因此也是可以移除的。

由于扩展内容的不会占用太多字节，因此移除前后文件大小不会有太大变化。

### 3. 减色

通常，一个连续的 GIF 动图，帧与帧之间的颜色差异不会很大，意味着大量相同的颜色被重复使用，因此这里面是有优化空间的。

关于 GIF 文件的颜色表：

- 一个 GIF 文件允许最多有一个全局颜色表，可供所有帧使用。
- 每一帧允许最多允许有一个本地颜色表，仅供当前帧使用。
- 一般情况下，至少会存在一种颜色表。若无本地颜色表，则从全局颜色表中寻找。
- 根据规范，颜色表支持 2 的 N 次方种颜色（N 取值 1 ~ 8），即支持 2 ~ 256 种颜色。

#### 3.1 移除本地颜色表

根据上文，如果本地颜色表不存在，就会往全局颜色表中寻找。这样的话，移除掉所有帧的本地颜色表就能节省一部分空间。

```shell
$ gifsicle --colors=256 source.gif > target.gif
```

其中 `--colors` 指定为 256 可确保颜色不会被丢失。

请注意 `--colors=num` 会做两件事：

- 一是，移除本地颜色表。
- 二是，减少颜色表数量至指定值，若指定值大于原本数量将会被忽略。

以下两张图片，前者每一帧含本地颜色表，后者仅含全局颜色表。优化前后对比：

```shell
/Users/frankie/Desktop/gif-test/input/B2-静帧-1.67s.gif
  原图：416.74 KB
  处理后：373.26 KB
  减少了：43.48 KB
  压缩比例：10.43%

/Users/frankie/Desktop/gif-test/input/F3-按钮触发后-2.13s.gif
  原图：957.43 KB
  处理后：956.25 KB
  减少了：1.18 KB
  压缩比例：0.12%
```

此方法对于存在本地颜色表的 GIF 图片，优化效果还是挺明显的，否则几乎无影响

#### 3.2 减少颜色表数量

```shell
$ gifsicle --colors=num source.gif > target.gif
```

其中 num 表示颜色表数量，取值范围 2 ~ 256。可同时使用 --color-method 参数以指定减少颜色表的算法（详看 [Gifsicle manual](https://www.lcdf.org/gifsicle/man.html)）。

请注意，颜色表数量仅支持 2 的 N 次方数量（ N 为 1 ~ 8）。

当使用 Gifsicle 处理图像时，假设指定为 --colors=120，将取可容纳的最小的数量 128，其中第 120 ~ 127 索引位被指定为 #000000（不排除有其他颜色值，但不重要，毕竟不会再有索引值指向它们）。

如果图像中含有透明色，实际处理过程中 num 可能会 +1。

对于普通 GIF 动图优化还是很明显的，但在微信交互图文应该是不能接受的，因此不推荐使用这种方式进行优化，原因有二：

- 一是，处理前后质量下滑肉眼可见，反而色彩差异倒不是太明显（比如减少至 128 种颜色时）。
- 二是，结果不可控。其中 Gifsicle 减少颜色表的默认算法为「diversity」。

### 4. 透明度存储

我们都知道，GIF 动图是由一帧一帧的位图组成的。但通常一个连续的 GIF 动态，帧与帧之间的差异不会很大，意味着重复部分会很多。

如果消除掉重复部分，那么整个文件占用空间将会大幅降低，这种方式称为「透明度存储」。

借助 Gifsicle 工具可实现透明度存储，命令如下：

```shell
$ gifsicle -O2 source.gif > target.gif
```

也可直接使用 `-O3` 参数，请注意这里是大写字母「O」，而不是数字「0」。

- `-O2`：Store only the changed portion of each image, and use transparency.
- `-O3`：Try several optimization methods (usually slower, sometimes better results).

一般情况下，这种优化方式在体积上会有「质」的变化，而且质量上几乎看不出有损失。

**但是，在你亲测之后或许会发现，效果并不明显，可能体积上只降低几个 KB 大小，甚至会多几个 KB（这方面官方文档有提到，但具体原因未说明）。**

原因很简单，设计师交付的图片已做了透明度处理，因此我们再使用 `gifsicle -O2` 处理时，结果是几乎没有变化的。

利用 [ImageMagick](https://imagemagick.org/script/convert.php) 将 GIF 逐帧导出：

```shell
$ brew install imagemagick
$ convert B2-静帧-1.67s.gif ./output/b.png
```

![](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1763979961779.png)

第一帧完整性最高，后续帧只保留了变化的部分，未变化部分表现为透明背景。

接着，利用 `gifsicle --unoptimize` 命令将 GIF 图片还原，再逐帧导出：

```shell
$ gifsicle --unoptimize B2-静帧-1.67s.gif > B2-origin.gif
$ convert B2-origin.gif ./output/b-origin.png
```

![](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1763979985516.png)

是的，这个才是 GIF 图的最初模样。原图大小为 2.1MB，透明度处理之后大小为 250KB，因此透明度存储这种方式的优化是巨大的。

请注意，采用透明度存储的方式，显示效果或许会受到 Disposal Method（定义帧之间的叠加效果）的影响，但一般情况下无需特别设置。若有需要 Gifsicle 也提供了 `--disposal` 参数供处理。

### 5. 有损压缩

GIF 的图像数据使用了 LZW 无损压缩算法。

也可以尝试 Gifsicle 提供的 --lossy 有损压缩选项，具体细节其文档中未体现（有兴趣可看 [kohler/gifsicle #16](https://github.com/kohler/gifsicle/pull/16)），因此实际效果不可预测。

```shell
$ gifsicle --lossy=num source.gif > target.gif
```

其中 num 取值范围是 20 ~ 200，默认为 20。贡献 --lossy 的作者 Kornel Lesiński 在 [Loosy GIF compressor](https://kornel.ski/lossygif) 指出：80 应该是一个比较合适的值。

> GIF's LZW compression is based on a "dictionary" of strings of pixels seen. Normal encoder searches the dictionary for the longest string of pixels that exactly matches pixels in the image. Lossy encoder picks longest string of pixels that's "similar enough" to pixels in the image (plus some magic to hide the distortions with dithering).

### 6. 抽帧

经过以上优化处理，或有了一定的效果，但可能还是不太满意。那你或许应该试一下「抽帧」处理。

其实，我们可以预知抽帧带来的影响：

- 帧数减少，时长变短，速率加快。
- 帧与帧之间的衔接不流畅，有噪点。

如何优化？

- 将 GIF 还原成未使用透明存储的状态，接着再抽帧，然后重新进行透明度优化，以减少噪点。
- ~~由于抽帧导致时长变短，造成速率加快的「现象」，因此可以尝试将所有帧的 Delay Time 取出相加，然后再重新分配。~~
- 抽帧不应抽取连续的帧。同时，切记不能抽去第一帧。

#### 直接抽帧 vs 先还原透明度再抽帧

以下测试图片，开始前已做透明度处理优化。

接着我们抽掉其中三帧，对比两种方式的优劣：

```shell
# 第一组：不还原透明度，直接抽帧
$ gifsicle source.gif --delete "#3" "#12" "#20" > target.gif

# 第二组：先将透明度还原，接着抽帧，最终作透明度优化
$ gifsicle source.gif --unoptimize --delete "#3" "#12" "#20" > temp.gif
$ gifsicle temp.gif -O2 > target.gif
```

结果如下，在体积上两组相差无几 👇 ：

```shell
/Users/frankie/Desktop/gif-test/input/F3-按钮触发后-2.13s.gif（第一组）
  原图：956.25 KB
  处理后：867.45 KB
  减少了：88.80 KB
  压缩比例：9.29%

/Users/frankie/Desktop/gif-test/input/F3-按钮触发后-2.13s.gif（第二组）
  原图：956.25 KB
  处理后：873.74 KB
  减少了：82.52 KB
  压缩比例：8.63%
```

在效果上，两组差异则非常明显（由于录制 GIF 图片有点麻烦，截图如下 👇 ）：

![](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1763980039270.png)

当然，并不是所有图片如第一组般处理时，效果都那么差。但批量处理图片的话，应先还原透明度，再抽帧，再优化透明度存储。

### ~~重新分配 Delay Time~~（废弃）

前面抽掉三帧之后，GIF 时长会发生变化，由原来的 2.13s 变为 1.92s。时长可使用 FFmpeg 工具查看：

```shell
$ ffprobe F3-按钮触发后-2.13s.gif
Input #0, gif, from 'F3-按钮触发后-2.13s.gif':
  Duration: 00:00:01.92, start: 0.000000, bitrate: 3701 kb/s
  Stream #0:0: Video: gif, bgra, 514x1101, 15.08 fps, 15.17 tbr, 100 tbn
```

这种方式对于每一帧 Delay Time 相同或相近的情况比较合适，因此局限性较大。

### 小结

基于以上提供的几个优化方向，大致可以划分为两类：

- 无损压缩：移除扩展内容、移除本地颜色表、透明度存储。
- 有损压缩：降低图片分辨率、减少颜色表数量、GifSicle Lossy、抽帧。

其中无损压缩适用于绝大多数项目。以微信交互图文项目为例，除了无损压缩，较为合适的只有适当地抽帧了。

## 快速抽帧技巧

利用 macOS 内置的「预览 App」可快速进行抽帧或添加帧等操作。

用预览打开图片，在「选取边栏显示」处切换至「缩略图」或「缩略清单」模式（如图 👇）。

- 删除帧：选中帧后，按下「⌘ + delete」组合键，可删除该帧。
- 添加帧：打开两组图片，选择上述模式之一，然后两组图片之间进行拖拽即可。比如，从 A.gif 中拖拽一帧到 B.gif，A.gif 帧数不会发生变化，B.gif 则会增加一帧。

![](https://cdn.jsdelivr.net/gh/tofrankie/blog@main/images/2025/11/1763980105871.png)

进行以上操作之前，建议先将原图备份。

### 优化脚本

初步想法，大概会支持一张或多张图片批量处理。

大致流程如下：

1. 若需要执行抽帧（通过参数区分），则先进行 gifsicle -U 操作以还原透明度，否则跳过。
2. 若需要执行抽帧，根据抽帧方式对图片进行抽帧操作，否则跳过。
3. 移除扩展内容、本地颜色表。
4. 对图片进行透明度存储。

抽帧形式，想法如下：

1. 随机抽帧：按比例抽取对应帧数。随机抽取的帧数，不能是第一帧，也不应该抽取连续帧。
2. 抽取指定帧：传入指定帧数，形如 `#3` `#9`。但这种方式不适用于批量处理。

以上操作，将会使用 Shell 脚本实现。

由于绝大多数场景可能不适合抽帧，暂不实现抽帧处理。

目前已编写了一个 Shell 脚本去「批量、无损」处理 GIF 图片，主要优化点是「透明度存储」、「移除 Local Color Table」、「移除对渲染无用的扩展内容」。

可通过 NPM 的方式安装此脚本。

```shell
# 全局安装
$ yarn global add https://github.com/tofrankie/gif-optimize.git

# 使用
$ gg <input-dir> -o <output-dir>
```

更多请移步 [gif-optimize](https://github.com/tofrankie/gif-optimize) 仓库。

## References

- [Gifsicle manual](https://www.lcdf.org/gifsicle/man.html)
- [ffmpeg Documentation](https://ffmpeg.org/ffmpeg.html)
- [Convert Between Image Formats (ImageMagick)](https://imagemagick.org/script/magick.php)
- [GIF89a Specification](https://www.w3.org/Graphics/GIF/spec-gif89a.txt)
- [You Don't Know Gif](https://blog.darrien.dev/posts/you-dont-know-gif/)（[译文](https://www.infoq.cn/article/fqe808mycqc0fb8u2dsx)）
- [GIF Application Extensions](http://www.vurdalakov.net/misc/gif)
- [腾讯技术分享：GIF 动图技术详解及手机 QQ 动态表情压缩技术实践](http://www.52im.net/thread-2032-1-1.html)
